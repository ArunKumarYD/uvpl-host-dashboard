<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Host Dashboard – UVPL</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; }
    h1 { background-color: #2e1065; color: white; padding: 1rem; border-radius: 8px; text-align: center; }
    button, select, input { margin: 0.5rem 0; padding: 0.5rem; font-size: 1rem; }
    .section { margin-top: 2rem; border-top: 2px solid #ddd; padding-top: 1.5rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    th { background-color: #2e1065; color: white; }
    .player-name:hover, .team-name:hover { cursor: pointer; color: green; font-weight: bold; }
    .live-box { background: #f5f5f5; padding: 1rem; margin-top: 1rem; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>🏐 Host Dashboard – UVPL</h1>
  <button onclick="window.open('players.html')">🏅 View Top Players</button>
  <button onclick="showSection('playerManager')">👥 Player Manager</button>
  <button onclick="showSection('matchScheduler')">📅 Match Scheduler</button>
  <button onclick="showSection('declareWinner')">🏆 Declare Winner</button>
  <button onclick="showSection('rulesEditor')">📘 Rules Editor</button>

  <div id="playerManager" class="section" style="display:none;">
    <h2>👥 Player Manager</h2>
    <p>Player manager section here...</p>
  </div>
  <div id="matchScheduler" class="section" style="display:none;">
    <h2>📅 Match Scheduler</h2>
    <p>Match scheduler section here...</p>
  </div>
  <div id="declareWinner" class="section" style="display:none;">
    <h2>🏆 Declare Winner</h2>
    <p>Declare winner section here...</p>
  </div>
  <div id="rulesEditor" class="section" style="display:none;">
    <h2>📘 Rules Editor</h2>
    <p>Rules editor section here...</p>
  </div>

  <!-- Match Control -->
  <div class="section">
    <h2>📺 Live Match Control</h2>
    <label>Date: <input type="date" id="matchDate"></label><br/>
    <label>Time:
      <select id="matchTime">
        <option>18:00</option><option>18:45</option><option>19:30</option><option>20:15</option>
      </select>
    </label><br/>
    <button onclick="startMatch()">🚀 Start Match</button>
    <div id="liveControls" style="display:none;" class="live-box">
      <h3>🎯 Live Match Controls</h3>
      <div id="liveTeams"></div>
      <div id="livePlayers"></div>
      <label>Declare Winner: <select id="winnerSelect"></select></label><br/>
      <button onclick="endMatch()">🏁 End Match & Update Points</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script>
    const db = firebase.database();
    const teams = ["United Challengers", "UC Twistter", "Azraq Astronuts", "IJC Ninjas"];
    let matchData = {}, team1Key = '', team2Key = '', gender = '';

    function showSection(id) {
      ["playerManager", "matchScheduler", "declareWinner", "rulesEditor"].forEach(sec => {
        document.getElementById(sec).style.display = (sec === id) ? 'block' : 'none';
      });
    }

    function startMatch() {
      const date = document.getElementById("matchDate").value;
      const time = document.getElementById("matchTime").value;
      if (!date || !time) return alert("Please select date and time");
      db.ref(`schedule/${date}/${time}`).once("value").then(snapshot => {
        const data = snapshot.val();
        if (!data || !data.team1 || !data.team2) return alert("Match not found");
        matchData = data;
        gender = data.gender;
        team1Key = data.team1;
        team2Key = data.team2;

        db.ref(`schedule/${date}/${time}`).update({ status: "Live" });

        document.getElementById("liveControls").style.display = "block";
        document.getElementById("liveTeams").innerHTML = `
          <p><span class='team-name' onclick="addTeamScore('${team1Key}')">${team1Key}</span> vs 
          <span class='team-name' onclick="addTeamScore('${team2Key}')">${team2Key}</span></p>
        `;
        document.getElementById("winnerSelect").innerHTML = `
          <option value="${team1Key}">${team1Key}</option>
          <option value="${team2Key}">${team2Key}</option>
        `;

        document.getElementById("livePlayers").innerHTML = "";
        loadPlayerList(gender, team1Key);
        loadPlayerList(gender, team2Key);
      });
    }

    function loadPlayerList(gender, team) {
      db.ref(`players/${gender}/${team}`).once("value").then(snap => {
        const players = snap.val();
        const div = document.createElement("div");
        div.innerHTML = `<h4>${team}</h4>`;
        Object.keys(players || {}).forEach(key => {
          const btn = document.createElement("button");
          btn.innerText = players[key].name;
          btn.className = "player-name";
          btn.onclick = () => addPlayerPoint(gender, team, key);
          div.appendChild(btn);
        });
        document.getElementById("livePlayers").appendChild(div);
      });
    }

    function addTeamScore(team) {
      const path = `schedule/${document.getElementById("matchDate").value}/${document.getElementById("matchTime").value}`;
      const scoreKey = team === team1Key ? "team1Score" : "team2Score";
      db.ref(`${path}/${scoreKey}`).transaction(val => (val || 0) + 1);
    }

    function addPlayerPoint(gender, team, playerKey) {
      db.ref(`players/${gender}/${team}/${playerKey}/points`).transaction(val => (val || 0) + 1);
    }

    function endMatch() {
      const date = document.getElementById("matchDate").value;
      const time = document.getElementById("matchTime").value;
      const winner = document.getElementById("winnerSelect").value;
      const loser = winner === team1Key ? team2Key : team1Key;
      const updates = {};

      updates[`schedule/${date}/${time}/status`] = "Completed";
      updates[`schedule/${date}/${time}/winner`] = winner;
      updates[`points/${gender}/${winner}/won`] = firebase.database.ServerValue.increment(1);
      updates[`points/${gender}/${loser}/lost`] = firebase.database.ServerValue.increment(1);
      updates[`points/${gender}/${winner}/points`] = firebase.database.ServerValue.increment(2);
      updates[`points/${gender}/${winner}/played`] = firebase.database.ServerValue.increment(1);
      updates[`points/${gender}/${loser}/played`] = firebase.database.ServerValue.increment(1);

      db.ref().update(updates).then(() => alert("✅ Match completed and points updated!"));
    }
  </script>
</body>
</html>
