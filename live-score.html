<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UVPL -5 LIVE SCORE SHEET</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    position: relative;
  }
  #watermark {
    position: fixed;
    top: 40%;
    left: 30%;
    font-size: 6rem;
    color: rgba(200, 200, 200, 0.15);
    transform: rotate(-30deg);
    pointer-events: none;
    user-select: none;
    z-index: 0;
  }
  header, footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  header img, footer img {
    max-height: 80px;
  }
  h1 {
    text-align: center;
    margin-bottom: 10px;
    position: relative;
    z-index: 1;
  }
  .team-container {
    border: 1px solid #444;
    padding: 15px;
    margin-bottom: 15px;
    position: relative;
    z-index: 1;
  }
  .team-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .team-logo {
    max-height: 60px;
    max-width: 120px;
  }
  .score {
    font-size: 2rem;
    font-weight: bold;
  }
  .players-list {
    margin-top: 10px;
  }
  .player-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 5px 0;
  }
  .player-name {
    flex-grow: 1;
  }
  button {
    padding: 3px 8px;
    font-size: 1rem;
    cursor: pointer;
  }
  #sets-status {
    margin: 20px 0;
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
  }
  #declare-winner-btn {
    display: block;
    margin: 20px auto;
    font-size: 1.1rem;
    padding: 10px 25px;
    cursor: pointer;
  }
  #referee-signature {
    margin-top: 40px;
    border-top: 1px solid #555;
    width: 300px;
    text-align: center;
    font-style: italic;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div id="watermark">UVPL - 5</div>

<header>
  <img id="companyLogo" src="assets/logos/company-logo.png" alt="Company Logo" />
  <h1>UVPL -5 LIVE SCORE SHEET</h1>
  <div style="width:120px"></div> <!-- placeholder to balance header -->
</header>

<div class="team-container" id="team1Container">
  <div class="team-header">
    <img id="team1Logo" class="team-logo" src="" alt="Team 1 Logo" />
    <div>
      <h2 id="team1Name">Team 1</h2>
      <div class="score" id="team1TotalScore">0</div>
    </div>
  </div>
  <div class="players-list" id="team1PlayersContainer">
    <!-- Players with + / - buttons appear here -->
  </div>
</div>

<div class="team-container" id="team2Container">
  <div class="team-header">
    <div>
      <h2 id="team2Name">Team 2</h2>
      <div class="score" id="team2TotalScore">0</div>
    </div>
    <img id="team2Logo" class="team-logo" src="" alt="Team 2 Logo" />
  </div>
  <div class="players-list" id="team2PlayersContainer">
    <!-- Players with + / - buttons appear here -->
  </div>
</div>

<div id="sets-status">Sets: 0 - 0</div>

<button id="declare-winner-btn" disabled>Declare Winner & Download PDF</button>

<div id="referee-signature" contenteditable="true" spellcheck="false" placeholder="Referee Signature (click to sign)"></div>

<footer>
  <small>UVPL - 5 &copy; 2025</small>
</footer>

<script>
(async () => {
  // Extract URL params
  const urlParams = new URLSearchParams(window.location.search);
  const gender = urlParams.get('gender');
  const team1Name = urlParams.get('team1');
  const team2Name = urlParams.get('team2');
  const matchDate = urlParams.get('date') || '';
  const matchTime = urlParams.get('time') || '';

  // GitHub raw JSON URL for teams and players (replace with your actual GitHub repo URL)
  const teamsPlayersUrl = 'https://raw.githubusercontent.com/YourGitHubUsername/YourRepoName/main/assets/data/teams-players.json';

  // Logo path folder
  const logoBasePath = 'assets/logos/';

  // State to hold scores and sets
  let team1Scores = { total: 0, players: {} };
  let team2Scores = { total: 0, players: {} };

  let setsWon = { team1: 0, team2: 0 };
  let currentSet = 1;

  // Load teams-players data from GitHub
  let teamsPlayers = {};
  try {
    const res = await fetch(teamsPlayersUrl);
    teamsPlayers = await res.json();
  } catch (err) {
    alert('Failed to load teams-players data.');
    console.error(err);
    return;
  }

  // Fill team names in UI
  document.getElementById('team1Name').textContent = team1Name;
  document.getElementById('team2Name').textContent = team2Name;

  // Set logos (put your logos in assets/logos folder with these exact names)
  document.getElementById('team1Logo').src = logoBasePath + team1Name.replace(/ /g, '-') + '.png';
  document.getElementById('team2Logo').src = logoBasePath + team2Name.replace(/ /g, '-') + '.png';
  document.getElementById('companyLogo').src = logoBasePath + 'company-logo.png';

  // Get players for each team & gender
  const team1Players = teamsPlayers[gender]?.[team1Name] || [];
  const team2Players = teamsPlayers[gender]?.[team2Name] || [];

  // Initialize player scores
  team1Players.forEach(p => team1Scores.players[p] = 0);
  team2Players.forEach(p => team2Scores.players[p] = 0);

  // Render players with +/- buttons
  function renderPlayers(containerId, players, scoreObj) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    players.forEach(player => {
      const div = document.createElement('div');
      div.className = 'player-row';
      div.innerHTML = `
        <span class="player-name">${player}</span>
        <button onclick="updatePlayerScore('${containerId}', '${player}', -1)">-</button>
        <span id="${containerId}-${player}-score">0</span>
        <button onclick="updatePlayerScore('${containerId}', '${player}', 1)">+</button>
      `;
      container.appendChild(div);
    });
  }

  window.updatePlayerScore = function(containerId, player, delta) {
    let scoreObj = containerId === 'team1PlayersContainer' ? team1Scores : team2Scores;
    scoreObj.players[player] = Math.max(0, scoreObj.players[player] + delta);

    // Update player score display
    const scoreSpan = document.getElementById(`${containerId}-${player}-score`);
    scoreSpan.textContent = scoreObj.players[player];

    // Recalculate total
    scoreObj.total = Object.values(scoreObj.players).reduce((a,b) => a + b, 0);
    if (containerId === 'team1PlayersContainer') {
      document.getElementById('team1TotalScore').textContent = scoreObj.total;
    } else {
      document.getElementById('team2TotalScore').textContent = scoreObj.total;
    }

    updateSetsStatus();
  };

  // Update sets status and check winner
  function updateSetsStatus() {
    const setsStatus = document.getElementById('sets-status');

    // For demonstration: each team wins a set if total score reaches 25+ and 2 points lead
    // Here simplified: if total score >= 25 and lead by 2, that team wins the set
    // After a set ends, scores reset and next set starts

    if (team1Scores.total >= 25 && team1Scores.total - team2Scores.total >= 2) {
      setsWon.team1++;
      currentSet++;
      resetScores();
    } else if (team2Scores.total >= 25 && team2Scores.total - team1Scores.total >= 2) {
      setsWon.team2++;
      currentSet++;
      resetScores();
    }

    setsStatus.textContent = `Sets: ${setsWon.team1} - ${setsWon.team2}`;

    // Enable Declare Winner button if any team has won 2 sets
    const declareBtn = document.getElementById('declare-winner-btn');
    if (setsWon.team1 === 2 || setsWon.team2 === 2) {
      declareBtn.disabled = false;
    } else {
      declareBtn.disabled = true;
    }
  }

  function resetScores() {
    // Reset player scores and totals for new set
    Object.keys(team1Scores.players).forEach(p => team1Scores.players[p] = 0);
    Object.keys(team2Scores.players).forEach(p => team2Scores.players[p] = 0);
    team1Scores.total = 0;
    team2Scores.total = 0;

    // Update UI
    for (const player of Object.keys(team1Scores.players)) {
      document.getElementById(`team1PlayersContainer-${player}-score`)?.textContent = '0';
      const spanId = `team1PlayersContainer-${player}-score`;
      const el = document.getElementById(spanId);
      if(el) el.textContent = '0';
    }
    for (const player of Object.keys(team2Scores.players)) {
      const spanId = `team2PlayersContainer-${player}-score`;
      const el = document.getElementById(spanId);
      if(el) el.textContent = '0';
    }
    document.getElementById('team1TotalScore').textContent = '0';
    document.getElementById('team2TotalScore').textContent = '0';
  }

  // Initial render
  renderPlayers('team1PlayersContainer', team1Players, team1Scores);
  renderPlayers('team2PlayersContainer', team2Players, team2Scores);

  // Handle Declare Winner & Download PDF
  document.getElementById('declare-winner-btn').onclick = () => {
    const winner = setsWon.team1 > setsWon.team2 ? team1Name : team2Name;
    generatePDF(winner);
  };

  function generatePDF(winner) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Title
    doc.setFontSize(18);
    doc.text('UVPL - 5 LIVE SCORE SHEET', 105, 15, null, null, 'center');

    // Date & Time
    doc.setFontSize(12);
    doc.text(`Date: ${matchDate}`, 15, 25);
    doc.text(`Time: ${matchTime}`, 15, 32);

    // Teams and logos (draw image is async, simplified here with placeholders)
    doc.setFontSize(14);
    doc.text(team1Name, 15, 45);
    doc.text(team2Name, 120, 45);

    // Total sets won
    doc.text(`Sets Won - ${team1Name}: ${setsWon.team1}`, 15, 55);
    doc.text(`Sets Won - ${team2Name}: ${setsWon.team2}`, 120, 55);

    // Winner
    doc.setFontSize(16);
    doc.text(`Winner: ${winner}`, 105, 65, null, null, 'center');

    // Player scores
    doc.setFontSize(12);
    doc.text('Player Scores:', 15, 75);

    // List players team 1
    let y = 82;
    for (const player of Object.keys(team1Scores.players)) {
      doc.text(`${player}: ${team1Scores.players[player]}`, 20, y);
      y += 7;
    }
    y += 5;
    doc.text('------------------', 15, y);
    y += 7;

    // List players team 2
    doc.text('Player Scores:', 120, 75);
    y = 82;
    for (const player of Object.keys(team2Scores.players)) {
      doc.text(`${player}: ${team2Scores.players[player]}`, 120, y);
      y += 7;
    }

    // Referee signature
    const refereeSig = document.getElementById('referee-signature').textContent.trim();
    if (refereeSig) {
      doc.text(`Referee: ${refereeSig}`, 15, y + 15);
    }

    doc.save(`UVPL5_${team1Name}_vs_${team2Name}_ScoreSheet.pdf`);
  }
})();
</script>
</body>
</html>
