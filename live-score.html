<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UVPL Live Score Sheet</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      background: url('assets/bg-watermark.png') no-repeat center center fixed;
      background-size: cover;
    }
    .score-btn { font-size: 1.2rem; margin: 0 4px; cursor: pointer; }
    .logo { height: 80px; }
    #top-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; }
  </style>
</head>
<body>
  <div id="top-header">
    <img src="assets/logos/company-logo.png" class="logo" alt="Company Logo">
    <h1>UVPL - 5 LIVE SCORE SHEET</h1>
    <div>
      <button onclick="downloadPDF()">Declare Winner & Download PDF</button>
    </div>
  </div>

  <div id="match-info">
    <h2 id="match-title">Loading match info...</h2>
  </div>

  <div style="display:flex; justify-content:space-around; align-items:center;">
    <img id="team1-logo" class="logo" src="" alt="Team 1 Logo" />
    <div>
      <table border="1">
        <thead>
          <tr><th>Set</th><th id="team1-name">Team 1</th><th id="team2-name">Team 2</th></tr>
        </thead>
        <tbody id="set-scores"></tbody>
        <tfoot>
          <tr><th>Total</th><td id="team1-total">0</td><td id="team2-total">0</td></tr>
        </tfoot>
      </table>
    </div>
    <img id="team2-logo" class="logo" src="" alt="Team 2 Logo" />
  </div>

  <div style="display: flex; justify-content: space-around;">
    <div>
      <h3 id="team1-player-title">Team 1 Players</h3>
      <ul id="team1-players"></ul>
    </div>
    <div>
      <h3 id="team2-player-title">Team 2 Players</h3>
      <ul id="team2-players"></ul>
    </div>
  </div>

  <div style="text-align:center; padding:20px;">
    <label>Referee Signature: <input type="text" id="ref-sign" placeholder="Enter referee name" /></label>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const gender = params.get('gender') || 'Men';
    const team1 = params.get('team1') || 'Team 1';
    const team2 = params.get('team2') || 'Team 2';
    const date = params.get('date') || '';
    const time = params.get('time') || '';

    document.getElementById('match-title').innerText = `${team1} vs ${team2} - ${date} ${time}`;
    document.getElementById('team1-name').innerText = team1;
    document.getElementById('team2-name').innerText = team2;
    document.getElementById('team1-player-title').innerText = team1 + ' Players';
    document.getElementById('team2-player-title').innerText = team2 + ' Players';

    document.getElementById('team1-logo').src = `assets/logos/${team1.replace(/\s+/g, '-')}.png`;
    document.getElementById('team2-logo').src = `assets/logos/${team2.replace(/\s+/g, '-')}.png`;

    let team1Total = 0, team2Total = 0;
    const setScores = document.getElementById('set-scores');
    const maxSets = 3;
    const sets = Array.from({length: maxSets}, (_, i) => ({ team1: 0, team2: 0 }));

    function renderScores() {
      setScores.innerHTML = '';
      sets.forEach((set, i) => {
        setScores.innerHTML += `
          <tr>
            <td>Set ${i+1}</td>
            <td><button onclick="updateSet(${i}, 'team1', -1)">-</button> ${set.team1} <button onclick="updateSet(${i}, 'team1', 1)">+</button></td>
            <td><button onclick="updateSet(${i}, 'team2', -1)">-</button> ${set.team2} <button onclick="updateSet(${i}, 'team2', 1)">+</button></td>
          </tr>
        `;
      });
      team1Total = sets.reduce((a,s)=>a+s.team1,0);
      team2Total = sets.reduce((a,s)=>a+s.team2,0);
      document.getElementById('team1-total').innerText = team1Total;
      document.getElementById('team2-total').innerText = team2Total;
    }
    function updateSet(index, team, delta) {
      sets[index][team] = Math.max(0, sets[index][team] + delta);
      renderScores();
    }
    renderScores();

    async function loadPlayers(team, elementId) {
      const path = `assets/players/${gender}/${team.replace(/\s+/g, '-')}.json`;
      try {
        const res = await fetch(path);
        const players = await res.json();
        const list = document.getElementById(elementId);
        players.forEach(p => {
          const li = document.createElement('li');
          li.innerHTML = `${p.name} <button onclick="updatePlayerScore(this, 1)">+</button> <button onclick="updatePlayerScore(this, -1)">-</button> <span class="score">0</span>`;
          list.appendChild(li);
        });
      } catch (e) {
        console.error('Failed to load players for', team);
      }
    }

    function updatePlayerScore(btn, delta) {
      const scoreSpan = btn.parentElement.querySelector('.score');
      let score = parseInt(scoreSpan.innerText) + delta;
      scoreSpan.innerText = Math.max(0, score);
    }

    loadPlayers(team1, 'team1-players');
    loadPlayers(team2, 'team2-players');

    async function downloadPDF() {
      const {{ jsPDF }} = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text(`UVPL Live Score Sheet`, 20, 20);
      doc.setFontSize(12);
      doc.text(`Match: ${team1} vs ${team2}`, 20, 30);
      doc.text(`Date: ${date} Time: ${time}`, 20, 38);
      doc.text(`Referee: ${document.getElementById('ref-sign').value}`, 20, 46);

      let y = 60;
      sets.forEach((set, i) => {
        doc.text(`Set ${i+1}: ${team1} ${set.team1} - ${team2} ${set.team2}`, 20, y);
        y += 8;
      });
      doc.text(`Total: ${team1} ${team1Total} - ${team2} ${team2Total}`, 20, y);

      y += 10;
      doc.text(`${team1} Player Scores:`, 20, y);
      document.querySelectorAll('#team1-players li').forEach((li, i) => {
        const name = li.innerText.split('+')[0].trim();
        const score = li.querySelector('.score').innerText;
        doc.text(`${name}: ${score}`, 25, y += 8);
      });

      y += 10;
      doc.text(`${team2} Player Scores:`, 20, y);
      document.querySelectorAll('#team2-players li').forEach((li, i) => {
        const name = li.innerText.split('+')[0].trim();
        const score = li.querySelector('.score').innerText;
        doc.text(`${name}: ${score}`, 25, y += 8);
      });

      doc.save(`UVPL_${team1}_vs_${team2}.pdf`);
    }
  </script>
</body>
</html>
